---
layout: post
title: ip网络层
tags:
- ip
categories: network
description: ip网络层
---

本文主要介绍计算机网络ip网络层的知识

# ip报文结构
<img src="/assets/img/network/ip1.png" width="650"/>

只介绍***关键字段***。

- 总长度
  
  指`IP首部和数据部分之和`的长度，单位是字节。

- 标识

  占16位。IP软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1，并将此值赋给标识字段。`但这个“标识”并不是序号`，因为IP是无连接服务，数据报不存在按序接收的问题。当数据报由于长度超过网络的MTU而必须分片时，这个标识字段的值就被复制到所有的数据报片的标识字段中。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。

- 片偏移
  
  占13位。片偏移指出：较长的分组在分片后，某片在`原分组中的相对位置`。也就是说，相对于用户数据字段的起点，该片从何处开始。片偏移以`8个字节为偏移单位`。

- 协议
  
  占8位，协议字段指出此数据报携带的数据是使用何种协议，以便使`目的主机的IP层知道应将数据部分上交给哪个处理过程`。
  
  常见协议和协议字段值如下
  
  <img src="/assets/img/network/ip2.png" width="650"/>

# ARP

已经知道了一个机器（主机或路由器）的IP地址，需要找出其相应的硬件地址。地址解析协议ARP就是用来解决这样的问题的。

由于传送ARP分组使用是IP协议，因此应当把`ARP协议划归网络层`。

<img src="/assets/img/network/ip3.png" width="650" alt="地址解析协议ARP工作原理"/>


# 划分子网
***两级的ip地址***，可以表示为 `IP地址:: = {<网络号>，<主机号>}`

全0的主机号字段表示该ip是一个子网，是一个子网(局域网)标识。
全1的主机号字段表示该网络上的所有主机。

----

`划分子网`，**三级ip地址**，可以表示为 `IP地址:: = {<网络号>，<子网号>，<主机号>}`

<img src="/assets/img/network/ip4.png" width="650" alt="网络145.13.0.0划分为三个子网，但对外仍是一个网络"/>

## 子网掩码
<img src="/assets/img/network/ip5.png" width="650" alt="IP地址的各字段和子网掩码（以145.13.3.30为例）"/>
使用子网掩码的好处就是：不管网络有没有划分子网，`只要把子网掩码和IP地址进行逐位的“与”运算(AND)，就立即得出网络地址来`。这样在路由器处理到来的分组时就可采用同样的算法。

## 使用子网时路由分组转发
使用子网划分后，路由表必须包含以下三项内容：目的网络地址、子网掩码和下一跳地址。在划分子网的情况下，路由器转发分组的算法如下：
- (1) 从收到的数据报的首部提取目的IP地址D。
- (2) 先判断是否为直接交付。对路由器直接相连的网络逐个进行检查：用各网络的子网掩码和 D 逐位相“与”（AND操作），看结果是否和相应的网络地址匹配。若匹配，则把分组进行直接交付（当然还需要把 D 转换成物理地址，把数据报封装成帧发送出去），转发任务结束。否则就是间接交付，执行(3)。
- (3) 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。
- (4) 对路由表中的每一行（目的网络地址，子网掩码，下一跳地址），用其中的子网掩码和D逐位相“与”（AND操作），其结果为N。若N与该行的目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器；否则，执行(5)。
- (5) 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)。
- (6) 报告转发分组出错。

<img src="/assets/img/network/ip6.png" width="650" alt="主机H1向H2发送分组"/>

【解】源主机H1向目的主机H2发送的分组的目的地址是H2的IP地址128.30.33.138。

源主机H1首先要进行的操作是要判断：`发送的这个分组，是在本子网上进行直接交付还是要通过本子网上的路由器进行间接交付`？

源主机H1 把本子网的“子网掩码255.255.255.128”与目的主机H2的“IP地址128.30.33.138”逐位相“与”（即逐位进行AND操作），得出128.30.33.128，它不等于H1的网络地址（128.30.33.0）。这说明H2与H1不在同一个子网上。因此H1不能把分组直接交付H2，而必须交给子网上的默认路由器R1，由R1来转发。

路由器R1在收到一个分组后，就在其路由表中逐行寻找有无匹配的网络地址。先看R1路由表中的第一行。用这一行的“子网掩码255.255.255.128”和收到的分组的“目的地址128.30.33.138”逐位相“与”（即逐位进行AND操作），得出128.30.33.128。然后和这一行给出的目的网络地址128.30.33.0进行比较。但比较的结果是不一致（即不匹配）。

用同样方法继续往下找第二行。用第二行的“子网掩码255.255.255.128”和该分组的“目的地址128.30.33.138”逐位相“与”（即逐位进行AND操作），结果也是128.30.33.128。但这个结果和第二行的目的网络地址128.30.33.128相匹配，说明这个网络（子网2）就是收到的分组所要寻找的目的网络。于是不需要再继续查找下去。R1把分组从接口1直接交付主机H2（它们都在一个子网上）。


# 超网CIDR
无分类编址CIDR使IP地址从三级编址（使用子网掩码）又回到了两级编址，但这已是无分类的两级编址。它的记法是：
`IP地址:: = {<网络前缀>，<主机号>}`

CIDR还使用“斜线记法”(slash notation)，或称为CIDR记法，`即在IP地址后面加上斜线“/”，然后写上网络前缀所占的位数`,如 128.14.35.7/20。


# ICMP
为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP (Internet Control Message Protocol)
<img src="/assets/img/network/icmp1.png" width="400" alt="ICMP报文的格式"/>

ICMP报文种类

<img src="/assets/img/network/icmp2.png" width="400" alt="ICMP报文种类"/>

## ping 
以`ping github.com`为例,wireshark抓包来看ICMP报文。

<img src="/assets/img/network/icmp3.png" width="600" alt=""/>

<img src="/assets/img/network/icmp4.png" width="700" alt=""/>

## traceroute 

# 虚拟专用网VPN
由于IP地址的紧缺，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数。考虑到因特网并不很安全，一个机构内也并不需要把所有的主机接入到外部的因特网。实际上，在许多情况下，很多主机主要还是和本机构内的其他主机进行通信（例如，在大型商场或宾馆中，有很多用于营业和管理的计算机。显然这些计算机并不都需要和因特网相连）。假定在一个机构内部的计算机通信也是采用TCP/IP协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其IP地址。这就是说，让这些计算机使用仅在本机构有效的IP地址（这种地址称为本地地址），而不需要向因特网的管理机构申请全球唯一的IP地址（这种地址称为全球地址）。这样就可以大大节约宝贵的全球IP地址资源。

<img src="/assets/img/network/ip7.png" width="600" alt=""/>



# 网络地址转换NAT
在专用网内部的一些主机本来已经分配到了本地IP地址（即仅在本专用网内使用的专用地址），但现在又想和因特网上的主机通信（并不需要加密），那么应当采取什么措施呢？

网络地址转换NAT (Network Address Translation)方法是在1994年提出的。这种方法需要在专用网连接到因特网的路由器上安装NAT软件。装有NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址。这样，所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和因特网连接。

<img src="/assets/img/network/ip8.png" width="600" alt=""/>


# 参考
1. [计算机网络 谢希仁]()